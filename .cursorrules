# Proposify Backend - Regras e Padr√µes do Projeto

## üìã Vis√£o Geral
Este √© um projeto Django REST Framework para uma plataforma de Marketplace de Servi√ßos.
- API REST pura (sem views/telas)
- Comunica√ß√£o via endpoints REST e WebSocket
- Python 3.14
- Django 5.2.8
- PostgreSQL como banco de dados

## üéØ Padr√µes de C√≥digo

### Estrutura de Arquivos
- **Models**: Sempre em `models.py` dentro de cada app
- **Enums**: Criar arquivo `enums.py` separado para cada app quando houver choices/constantes
- **Views**: Sempre em `views.py` (DRF ViewSets/APIViews)
- **Serializers**: Criar arquivo `serializers.py` separado
- **URLs**: Sempre em `urls.py` dentro de cada app
- **Tests**: Sempre em `tests.py` ou arquivos `test_*.py`

### Nomenclatura
- **Classes**: PascalCase (ex: `OrderStatus`, `UserType`)
- **Fun√ß√µes/M√©todos**: snake_case (ex: `get_user_profile`, `can_be_cancelled`)
- **Vari√°veis**: snake_case (ex: `user_type`, `order_status`)
- **Constantes**: UPPER_SNAKE_CASE (ex: `MAX_RETRIES`, `DEFAULT_TIMEOUT`)
- **Arquivos**: snake_case (ex: `models.py`, `enums.py`, `serializers.py`)

### Enums e Choices
- **SEMPRE** usar `enum.Enum` ao inv√©s de `models.TextChoices` ou strings hardcoded
- Criar arquivo `enums.py` separado em cada app quando houver choices
- Enums devem herdar de `str, Enum` para compatibilidade com Django
- Implementar m√©todo `choices()` que retorna tuplas (value, label)
- Implementar propriedade `label` para labels leg√≠veis
- Usar `.value` ao comparar ou atribuir valores de enum

**Exemplo:**
```python
# api/orders/enums.py
from enum import Enum

class OrderStatus(str, Enum):
    PENDING = 'PENDING'
    ACCEPTED = 'ACCEPTED'
    
    @property
    def label(self):
        labels = {'PENDING': 'Pendente', 'ACCEPTED': 'Aceito'}
        return labels.get(self.value, self.value)
    
    @classmethod
    def choices(cls):
        return [(member.value, member.label) for member in cls]
```

### Models Django
- **SEMPRE** usar `SoftDeleteMixin` para modelos que precisam de soft delete
- Adicionar `# type: ignore` em campos de modelo para suprimir warnings do type checker
- Usar `verbose_name` e `help_text` em todos os campos
- Adicionar √≠ndices apropriados em `Meta.indexes`
- Implementar `__str__` em todos os modelos
- Usar `related_name` expl√≠cito em ForeignKeys e OneToOneFields

**Exemplo:**
```python
class Order(SoftDeleteMixin, models.Model):
    status = models.CharField(  # type: ignore
        max_length=20,
        choices=OrderStatus.choices(),
        default=OrderStatus.PENDING.value,
        verbose_name='Status',
        help_text='Status atual do pedido'
    )
```

### Type Hints e Type Checking
- Adicionar `# type: ignore` em campos de modelo Django
- Adicionar `# pyright: reportIncompatibleVariableOverride=false` quando necess√°rio
- Usar `# noqa: E501` para linhas longas quando necess√°rio
- Configurar `pyrightconfig.json` e `pyproject.toml` para type checking

### Imports
- Ordem: stdlib, third-party, local
- Usar imports absolutos (ex: `from api.accounts.models import User`)
- Agrupar imports relacionados

### Commits Git
- Usar Conventional Commits:
  - `feat:` para novas funcionalidades
  - `fix:` para corre√ß√µes de bugs
  - `refactor:` para refatora√ß√µes
  - `docs:` para documenta√ß√£o
  - `test:` para testes
  - `chore:` para tarefas de manuten√ß√£o
- Mensagens em portugu√™s
- Descri√ß√£o detalhada do que foi feito

**Exemplo:**
```
feat: adiciona modelos Order e Proposal

- Cria modelo Order (pedido de servi√ßo feito pelo cliente)
- Cria modelo Proposal (proposta feita por prestador)
- Adiciona Soft Delete (deleted_at) em ambos modelos
- Implementa status choices: OrderStatus e ProposalStatus
```

### Soft Delete
- **SEMPRE** usar `SoftDeleteMixin` para modelos que precisam de soft delete
- Usar `SoftDeleteManager` para filtrar objetos deletados automaticamente
- Usar `all_objects` para acessar todos os objetos (incluindo deletados)
- Usar `deleted_objects` para acessar apenas objetos deletados
- Usar `restore()` para restaurar objetos deletados
- Usar `hard_delete()` para deletar permanentemente

### Migrations
- Criar migrations ap√≥s mudan√ßas em modelos
- Aplicar migrations ap√≥s criar
- Verificar com `python manage.py check` antes de commitar
- Nunca editar migrations j√° aplicadas
- Para altera√ß√µes que modifiquem tabelas de models j√° criados, utilizar alter table ou comandos que modifiquem a tabela, nunca mudar a migration anterior

### Testes
- Criar testes unit√°rios para modelos e l√≥gica de neg√≥cio
- Criar testes de integra√ß√£o para endpoints
- Usar `TestCase` do Django
- Testar soft delete, valida√ß√µes, e m√©todos customizados
- Criar arquivos para os mocks, para n√£o reescrev√™-los em v√°rios lugares diferentes
- Quando os testes sendo desenvolvidos passarem, antes de ter como finalizados, rode todos os testes para garantir que outro teste n√£o tenha quebrado

### Documenta√ß√£o
- Docstrings em portugu√™s para todas as classes e fun√ß√µes p√∫blicas
- Usar formato Google/NumPy style
- Documentar par√¢metros, retornos e exce√ß√µes
- Adicionar exemplos quando relevante
- Arquivos de documenta√ß√£o devem ficar dentro da pasta docs/ e ter um nome para que seja f√°cil de saber do que se trata
- Se o c√≥digo for ser criado com coment√°rio muito grandes (mais de 5 linhas de coment√°rio), crie um arquivo documentando, no coment√°rio apenas diga onde est√° o arquivo de documenta√ß√£o

**Exemplo:**
```python
def can_be_cancelled(self):
    """
    Retorna True se o pedido pode ser cancelado.
    
    Returns:
        bool: True se o status permite cancelamento
    """
    return self.status in [OrderStatus.PENDING.value, OrderStatus.ACCEPTED.value]
```

### Configura√ß√µes Django
- Settings organizados em `base.py`, `dev.py`, `prod.py`
- Usar `python-decouple` para vari√°veis de ambiente
- Configurar logging estruturado (JSON)
- Configurar Sentry condicionalmente (apenas se DSN fornecido)

### Seguran√ßa
- **NUNCA** commitar credenciais ou secrets
- Usar vari√°veis de ambiente para configura√ß√µes sens√≠veis
- Validar inputs em serializers
- Usar permiss√µes apropriadas em views

### Performance
- Adicionar √≠ndices em campos frequentemente consultados
- Usar `select_related` e `prefetch_related` quando apropriado
- Evitar N+1 queries

### Logging
- Usar logging estruturado (JSON)
- N√≠veis apropriados: DEBUG (dev), INFO (prod)
- Logar erros e opera√ß√µes importantes

## üö´ O Que N√ÉO Fazer

- ‚ùå **NUNCA** usar strings hardcoded para choices/enums
- ‚ùå **NUNCA** commitar arquivos `.env` ou secrets
- ‚ùå **NUNCA** editar migrations j√° aplicadas
- ‚ùå **NUNCA** usar `models.TextChoices` - sempre usar `enum.Enum`
- ‚ùå **NUNCA** criar modelos sem `SoftDeleteMixin` quando apropriado
- ‚ùå **NUNCA** esquecer de adicionar `# type: ignore` em campos de modelo
- ‚ùå **NUNCA** criar commits sem mensagem descritiva
- ‚ùå **NUNCA** executar os comandos do python e de qualquer opera√ß√£o de depend√™ncias fora do ambiente venv

## ‚úÖ Checklist Antes de Commitar

- [ ] C√≥digo passa em `python manage.py check`
- [ ] Sem erros de linter (flake8, mypy, pyright)
- [ ] Migrations criadas e aplicadas (se necess√°rio)
- [ ] Testes passando (se houver)
- [ ] Documenta√ß√£o atualizada (se necess√°rio)
- [ ] Commits seguem padr√£o Conventional Commits
- [ ] Mensagem de commit em portugu√™s e descritiva

## üìù Notas Importantes

- Sempre operar dentro do venv (`source venv/bin/activate`)
- Usar `--settings=config.settings.dev` para comandos Django em desenvolvimento
- Verificar `todo.md` para acompanhar progresso das tarefas
- Seguir a proposta em `docs/proposta.md` para implementa√ß√£o de features

